<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>FreeCam - A free zoom alternative</title>

    <!-- Bootstrap -->
  <!--  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" integrity="sha384-Zug+QiDoJOrZ5t4lssLdxGhVrurbmBWopoEl+M6BdEfwnCJZtKxi1KgxUyJq13dy" crossorigin="anonymous"> -->
    <link href="style/bootstrap.min.css" rel="stylesheet" />
    <link href="style/custom.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style/animation.css"><!--[if IE 7]><link rel="stylesheet" href="style/jitsi-ie7.css"><![endif]-->
    <link rel="stylesheet" href="style/jitsi.css">
    <!-- HTML5 shim and Respond.js for IE8 support o f HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script> <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script> <![endif]-->
  </head>
  <body>
    <div class="navbar navbar-expand-lg fixed-bottom navbar-dark bg-dark">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbar2" aria-controls="navbar2" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Collection of nav links and other content for toggling -->
        <div class="navbar-collapse collapse" id="navbar2">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="#" id="joinAudio">Join Audio</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="joinVideo">Join Video</a>
            </li>
          </ul>
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="#" id="inviteButton">Invite</a>
            </li>
          <!--  <li class="nav-item">
              <a class="nav-link" href="#" id="participantsButton">Participants</a>
            </li> -->
            <li class="nav-item">
              <a class="nav-item" href="#" id="screenShareButton" data-toggle="tooltip" data-html="true" title="Tooltip on top">
                <i class="icon-share-desktop"></i>
              </a>
            </li>
        <!--    <li class="nav-item">
              <a class="nav-link" href="#" id="chatButton">Chat</a>
            </li> -->
          </ul>
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="#" id="leaveMeeting" style="color: red; font-weight: bold;">Leave Meeting</a>
            </li>
          </ul>
        </div>
      </div>
    </div>

      <div class="camera-container" id="cameras">
        <div class="camera-wrap">
          <video id="localVideo" oncontextmenu="return false;" class="active"></video>
          <div class="username" id="localUsername">
            Test
          </div>
        </div>
      </div>

    <div class="modal bd-example-modal-lg" data-backdrop="static" id="joinRoomModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Join Meeting</h5>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="recipient-name" class="form-control-label">Username:</label>
                <input type="text" class="form-control" id="usernameInput">
              </div>
              <div class="form-group">
                <label for="message-text" class="form-control-label">Meeting ID:</label>
                <input type="text" class="form-control" id="meetingIdInput"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <!--<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>-->
            <button type="button" class="btn btn-primary" id="joinMeetingButton" enabled=false>Join</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="showInviteLinkModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Invite People</h5>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="recipient-name" class="form-control-label">Meeting Link:</label>
                <input type="text" class="form-control" style="color: white;" id="meetingLinkInput" readonly=readonly>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div id="load-overlay">
      <img src="images/Spinner.gif" alt="Loading" /><br/>
      Loading...
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js" integrity="sha384-a5N7Y/aK3qNeh15eJKGWxsqtnX/wWdSZSKp+81YjTmS15nvnvxKHuzaWwXHDli+4" crossorigin="anonymous"></script>
    <script src="js/simplewebrtc.bundle.js"></script>
    <script src="js/cookies.js"></script>
    <script type="text/javascript">
    var room = location.search && location.search.split('?')[1];
      //    usernameInput
          var usernameCookie = getCookie("freecam-username");
          if (usernameCookie != null){
            $('#usernameInput')[0].value = usernameCookie;
          }

          if (room){
            $('#meetingIdInput')[0].value = room;
            $('#joinRoomModal').modal();
          }

          $(window).ready(function(){
            $('#load-overlay').fadeOut();
          });
          // create our webrtc connection
          var webrtc = new SimpleWebRTC({
              // the id/element dom element that will hold "our" video
              localVideoEl: 'localVideo',
              // the id/element dom element that will hold remote videos
              remoteVideosEl: '',
              // immediately ask for camera access
              autoRequestMedia: true,
              debug: false,
              detectSpeakingEvents: true,
              nick: $('#usernameInput')[0].value,
              media: {
                  audio: false,
                  video: true
              }

          });

          webrtc.on('readyToCall', function () {
            $('#joinMeetingButton')[0].enabled = true;
          });

          webrtc.on('channelMessage', function (peer, label, data) {

          });

          webrtc.on('videoAdded', function (video, peer) {
              console.log('video added', peer);
              if (peer.type == "video"){
                var remotes = document.getElementById('cameras');
                if (remotes) {
                    var d = document.createElement('div');
                    d.className = 'camera-wrap';
                    d.id = 'container_' + webrtc.getDomId(peer);
                    d.appendChild(video);

                    var usernameDiv = document.createElement('div');
                    usernameDiv.className = "username";
                    usernameDiv.id = "username_" + webrtc.getDomId(peer);
                    usernameDiv.innerHTML = peer.nick;
                    d.appendChild(usernameDiv);

                    remotes.appendChild(d);
                }
              } else if (peer.type == "screen") {

              }

              makeEqualSize();
          });

          webrtc.on('videoRemoved', function (video, peer) {
              console.log('video removed ', peer);
              var remotes = document.getElementById('cameras');
              var el = document.getElementById('container_' + webrtc.getDomId(peer));
              if (remotes && el) {
                  remotes.removeChild(el);
              }

              makeEqualSize();
          });

          // Since we use this twice we put it here
          function setRoom(name) {
              var newUrl = location.pathname + '?' + name;
              history.replaceState({foo: 'bar'}, null, newUrl);
              $('#meetingLinkInput')[0].value = location.href;
          }

          var videoToggle = $('#joinVideo'),
             setVideo = function(bool) {
               videoToggle.text(bool ? 'Join Video' : 'Leave Video');
             };

         videoToggle.click(function () {
           if (webrtc.webrtc.isVideoEnabled()){
             webrtc.pauseVideo();
           }else{
             webrtc.resumeVideo();
           }
         });

          var audioToggle = $('#joinAudio'),
             setAudio = function(bool) {
               audioToggle.text(bool ? 'Join Audio' : 'Leave Audio');
             };

         audioToggle.click(function () {
           if (webrtc.webrtc.isAudioEnabled()){
             webrtc.mute();
           }else{
             webrtc.unmute();
           }
         });

         webrtc.on('audioOn', function () {
           setAudio(false);
         });
         webrtc.on('audioOff', function () {
             setAudio(true);
         });
         webrtc.on('videoOn', function () {
             setVideo(false);
         });
         webrtc.on('videoOff', function () {
             setVideo(true);
         });

          var button = $('#screenShareButton'),
              setButton = function (bool) {
                  button.title = (bool ? 'Share Screens' : 'Stop Sharing');
              };

        if (!webrtc.capabilities.supportScreenSharing) {
            button.disabled = 'disabled';
          }

          webrtc.on('localScreenStopped', function () {
              setButton(true);
          });

          setButton(true);
          setAudio(true);
          setVideo(false);

          button.click(function () {
              if (webrtc.getLocalScreen()) {
                  webrtc.stopScreenShare();
                  setButton(true);
              } else {
                  webrtc.shareScreen(function (err) {
                      if (err) {
                          setButton(true);
                      } else {
                          setButton(false);
                      }
                  });

              }
          });

          $('#leaveMeeting').click(function () {
            webrtc.leaveRoom();
            webrtc.pauseVideo();
            $('#usernameInput')[0].value = webrtc.webrtc.config.nick;
            $('#joinRoomModal').modal();
          });

          $('#joinMeetingButton').click(function () {
            webrtc.webrtc.config.nick = $('#usernameInput')[0].value;
            $('#localUsername')[0].innerHTML = webrtc.webrtc.config.nick;

            if (webrtc.webrtc.config.nick){
              setCookie("freecam-username", webrtc.webrtc.config.nick, 356);
            }

            var name = $('#meetingIdInput')[0].value;
            webrtc.joinRoom(name);
            setRoom(name);
            webrtc.resumeVideo();
            $('#joinRoomModal').modal('hide');
          });

          $('#inviteButton').click(function () {
            $('#showInviteLinkModal').modal('toggle');
          });

          $('#meetingLinkInput').click(function () {
            $(this).select();
          });

          function getRandomInt(min, max) {
              return Math.floor(Math.random() * (max - min + 1)) + min;
          }

          function makeEqualSize() {
            var wrap = $('.camera-container');
            var elements = $(".camera-container").find('.camera-wrap');

            var count = elements.length;
            var margin = 6;
            var windowWidth = wrap.width() - (count * margin);
            var windowHeight = wrap.height() - (count * margin);

            var rows = Math.floor(Math.sqrt(count));
            var cols = Math.ceil(Math.sqrt(count));

            var elWidth = ((windowWidth - (count * margin))  / cols);
          //  var elHeight = ((windowHeight - (count * margin)) / rows);
            var elHeight = elWidth * 0.5625;

            if (windowWidth * 1.5625 < windowHeight){
              elHeight = ((windowWidth - (count * margin)) / cols);
              elWidth = ((windowHeight - (count * margin)) / rows);
            }

            elements.css({
              width: elWidth + "px",
              height: elHeight + "px"
            });

          }

      $(document).ready(function () {
        $(window).resize(function (e) {
          makeEqualSize();
        });

        makeEqualSize()
      });
    </script>

  </body>
</html>
